<!DOCTYPE html>
<html lang="zh-HK">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>æ¯”è³½ç°½åˆ°ç³»çµ±</title>

<style>
body{font-family:Arial;background:#000;color:#fff;margin:0;text-align:center}
header{background:#111;padding:18px;font-size:26px;font-weight:bold}
input,button{width:92%;max-width:420px;padding:20px;margin:12px auto;
font-size:26px;border-radius:12px;border:none}
.event-btn{background:#1E88E5;color:#fff}
.first-btn{background:#43A047;color:#fff}
.back-btn{background:#555;color:#fff}
#scanner{max-width:520px;margin:auto}
#status{font-size:40px;font-weight:bold;margin-top:40px}
.member{font-size:30px;margin-top:10px}
.success{color:#4CAF50}
.error{color:#FF5252}
.hidden{display:none}
.small{font-size:16px;opacity:.6}
</style>
</head>

<body>

<header id="header">ğŸ” å·¥ä½œäººå“¡ç™»å…¥</header>

<!-- å·¥ä½œäººå“¡ -->
<div id="staffPage">
  <input id="staffInput" placeholder="è¼¸å…¥å·¥ä½œäººå“¡åç¨±">
  <button class="event-btn" onclick="saveStaff()">é–‹å§‹</button>
  <div id="deviceInfo" class="small"></div>
</div>

<!-- ä¸ƒå€‹ç°½åˆ°é …ç›® -->
<div id="eventPage" class="hidden">
  <button class="first-btn" onclick="selectEvent('é¦–æ¬¡å ±åˆ°')">â‘  é¦–æ¬¡å ±åˆ°</button>
  <button class="event-btn" onclick="selectEvent('é …ç›®ä¸€')">â‘¡ é …ç›®ä¸€</button>
  <button class="event-btn" onclick="selectEvent('é …ç›®äºŒ')">â‘¢ é …ç›®äºŒ</button>
  <button class="event-btn" onclick="selectEvent('é …ç›®ä¸‰')">â‘£ é …ç›®ä¸‰</button>
  <button class="event-btn" onclick="selectEvent('é …ç›®å››')">â‘¤ é …ç›®å››</button>
  <button class="event-btn" onclick="selectEvent('é …ç›®äº”')">â‘¥ é …ç›®äº”</button>
  <button class="event-btn" onclick="selectEvent('é …ç›®å…­')">â‘¦ é …ç›®å…­</button>
</div>

<div id="backArea" class="hidden">
  <button class="back-btn" onclick="back()">â¬… è¿”å›é¸æ“‡</button>
</div>

<div id="scanner" class="hidden"></div>
<div id="status" class="hidden"></div>

<script src="https://unpkg.com/html5-qrcode"></script>
<script>
// ===== Google Form =====
const FORM_URL="https://docs.google.com/forms/d/e/1FAIpQLSfb9TdBGH6aGtpX1chUArd-61hNR2QSOjyZ55_MJkReu4BZCQ/formResponse";
const ENTRY_MEMBER="entry.440560781";
const ENTRY_EVENT="entry.722246826";
const ENTRY_STAFF="entry.1290533017";
const ENTRY_DEVICE="entry.389796138";
// =======================

let staff=localStorage.getItem("staff")||"";
let device=localStorage.getItem("device")||"";
let eventName="",qr;

const header=document.getElementById("header");
const staffPage=document.getElementById("staffPage");
const eventPage=document.getElementById("eventPage");
const scanner=document.getElementById("scanner");
const statusBox=document.getElementById("status");
const deviceInfo=document.getElementById("deviceInfo");
const backArea=document.getElementById("backArea");

// è£ç½® ID
if(!device){
 device="DEV-"+Math.random().toString(36).substr(2,6).toUpperCase();
 localStorage.setItem("device",device);
}
deviceInfo.innerText="è£ç½® IDï¼š"+device;

// å·²ç™»å…¥
if(staff){
 staffPage.classList.add("hidden");
 eventPage.classList.remove("hidden");
 header.innerText="ğŸ“‹ é¸æ“‡ç°½åˆ°é …ç›®";
}

function saveStaff(){
 const v=document.getElementById("staffInput").value.trim();
 if(!v)return alert("è«‹è¼¸å…¥åç¨±");
 staff=v;localStorage.setItem("staff",v);
 staffPage.classList.add("hidden");
 eventPage.classList.remove("hidden");
 header.innerText="ğŸ“‹ é¸æ“‡ç°½åˆ°é …ç›®";
}

function selectEvent(e){
 eventName=e;
 header.innerText="ğŸ“· æƒæ QRï½œ"+e;
 eventPage.classList.add("hidden");
 backArea.classList.remove("hidden");
 scanner.classList.remove("hidden");
 qr=new Html5Qrcode("scanner");
 qr.start({facingMode:"environment"},{fps:10,qrbox:280},scan);
}

function back(){
 if(qr)qr.stop().catch(()=>{});
 scanner.classList.add("hidden");
 backArea.classList.add("hidden");
 eventPage.classList.remove("hidden");
 header.innerText="ğŸ“‹ é¸æ“‡ç°½åˆ°é …ç›®";
}

function scan(id){
 qr.pause();
 submit(id);
}

function submit(id){
 const d=new FormData();
 d.append(ENTRY_MEMBER,id);
 d.append(ENTRY_EVENT,eventName);
 d.append(ENTRY_STAFF,staff);
 d.append(ENTRY_DEVICE,device);

 fetch(FORM_URL,{method:"POST",mode:"no-cors",body:d})
  .then(()=>show(true,id))
  .catch(()=>show(false,id));
}

function show(ok,id){
 scanner.classList.add("hidden");
 if(navigator.vibrate){
   ok?navigator.vibrate([80,60,80]):navigator.vibrate(300);
 }
 statusBox.className=ok?"success":"error";
 statusBox.innerHTML=`${ok?"âœ… ç°½åˆ°æˆåŠŸ":"âŒ ç°½åˆ°å¤±æ•—"}
 <div class="member">${eventName}<br>æˆå“¡ IDï¼š${id}</div>`;
 statusBox.classList.remove("hidden");

 setTimeout(()=>{
  statusBox.classList.add("hidden");
  scanner.classList.remove("hidden");
  qr.resume();
 },ok?500:1000);
}
</script>
</body>
</html>